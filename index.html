<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScreenGolf v4.6.2 — All-in-One (Cloud, ₱, D-day Lockers)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- ✅ 자동 연결(중복 초기화 방지 + Cloud 헬퍼 연동) -->
  <script>
    // Firebase 설정
    const DEFAULT_CFG = {
      apiKey: "AIzaSyB1mCK2eKIBsvh3AD9W6DhHjR0PvbgOFqk",
      authDomain: "test-99e9a.firebaseapp.com",
      projectId: "test-99e9a",
      storageBucket: "test-99e9a.appspot.com",
      messagingSenderId: "224490775188",
      appId: "1:224490775188:web:589f24bdfdf76880574a81"
    };

    // 페이지 로드시 자동 연결 (중복 initialize 금지)
    (function autoConnectFirebase(){
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(DEFAULT_CFG);
        } // 이미 초기화되어 있으면 재사용

        // Cloud 헬퍼가 준비되면 설정 주입
        window.addEventListener('DOMContentLoaded', () => {
          try {
            localStorage.setItem('sg_v462_cloud', JSON.stringify(DEFAULT_CFG));
            if (window.Cloud && !Cloud.ready()) {
              Cloud.setConfig(DEFAULT_CFG);       // 재사용 로직이라 에러 없음
              if (window.watchDay && window.state) {
                watchDay(state.date);             // 실시간 구독 리바인딩
              }
            }
          } catch (e) {
            console.error(e);
          }
        });
      } catch (e) {
        console.error('Firebase init failed:', e);
        alert('Firebase init failed: ' + e.message);
      }
    })();
  </script>

  <style>
    body { background:#0b1020; color:#fff; }
    .card { background:#0f172a; border:1px solid #1f2a44; border-radius:16px; }
    .muted { color:rgba(255,255,255,0.65); }
    .btn { background:#334155; border:1px solid #475569; border-radius:12px; padding:8px 12px; }
    .btn:hover { background:#475569; }
    .btn-main { background:#2563eb; border-color:#2563eb; }
    .btn-main:hover { background:#1d4ed8; }
    .btn-danger { background:#b91c1c; border-color:#b91c1c; }
    .btn-danger:hover { background:#dc2626; }
    .input{ background:#0b1228; border:1px solid #334155; border-radius:10px; padding:8px 10px; width:100%; color:#fff;}
    .grid-scroll { overflow:auto; max-height: 66vh; }
    .cell { border-bottom:1px solid #1f2a44; border-right:1px solid #1f2a44; min-height:36px; position:relative; }
    .timecell { border-bottom:1px solid #1f2a44; min-height:36px; color:#9aa4b2; font-size:12px; padding:8px; position:sticky; left:0; background:#0b1020; z-index:2; }
    .roomheader { position:sticky; top:0; z-index:3; background:#0b1020; border-bottom:1px solid #1f2a44; padding:8px; text-align:center; font-weight:600; }
    .cell.selecting { background:rgba(59,130,246,0.25); }
    .booking { position:absolute; left:2px; right:2px; border-radius:8px; background:rgba(59,130,246,0.65); border:1px solid #60a5fa; padding:4px 6px; font-size:12px; }
    .badge { border:1px solid #334155; background:#0b1228; border-radius:999px; padding:2px 8px; font-size:12px; }
    .tab { padding:10px 14px; border-radius:12px; margin-right:6px; }
    .tab.active { background:#2563eb; }
    table.table th, table.table td { border-bottom:1px solid #1f2a44; padding:8px; text-align:left; }
    .dash-card { border:1px solid #1f2a44; border-radius:16px; padding:14px; background:#0f172a; cursor:pointer; transition:transform .05s ease; }
    .dash-card:hover { transform: translateY(-1px); }
    .status { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #334155; background:#0b1228; }
    .status.run { border-color:#1c7945; color:#a7f3d0; }
    .status.idle { color:#cbd5e1; }
    .big { font-size:28px; font-weight:700; }
    .sub { font-size:12px; color:#9aa4b2; }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; }
    .modal { width:900px; max-width:95vw; }
    .pill { border:1px solid #334155; background:#0b1228; border-radius:999px; padding:2px 8px; font-size:12px; }
    /* Lockers */
    .locker { border:1px solid #1f2a44; border-radius:12px; padding:10px; background:#0f172a; min-height:78px; cursor:pointer; }
    .locker:hover { background:#14203b; }
    .locker .num { font-weight:700; font-size:14px; color:#9aa4b2; }
    .locker .name { font-weight:600; margin-top:2px; }
    .locker .days { font-size:12px; color:#cbd5e1; }
    .danger { outline:2px solid #dc2626; }
    .warn { outline:2px solid #f59e0b; }
  </style>
</head>
<body>
  <div class="p-4 md:p-8 max-w-7xl mx-auto">
    <header class="mb-6">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">ScreenGolf v4.6.2 — All-in-One</h1>
          <p class="muted text-sm">Reservations · Inventory · Sales · Members · Lockers(D-day) · Reports · Pricing + Live Dashboard</p>
        </div>
        <div class="flex items-center gap-2">
          <input type="date" id="day" class="input w-[180px]" />
          <button id="todayBtn" class="btn">Today</button>
          <!-- Cloud 버튼 제거됨 -->
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="reservations">Reservations</button>
        <button class="tab" data-tab="sales">Sales (POS)</button>
        <button class="tab" data-tab="inventory">Inventory</button>
        <button class="tab" data-tab="members">Members</button>
        <button class="tab" data-tab="lockers">Lockers</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="pricing">Pricing Rules</button>
      </div>
    </header>

    <!-- Dashboard -->
    <section id="tab-dashboard">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="dashGrid"></div>
      <div class="muted text-sm mt-2">Click a card to start/extend/settle timer, add items, and view real-time totals.</div>
    </section>

    <!-- Reservations -->
    <section id="tab-reservations" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-3 card">
          <div class="p-4 flex items-center justify-between">
            <div class="text-lg font-semibold">Reservation Calendar</div>
            <div class="flex items-center gap-2">
              <button id="addGameBtn" class="btn btn-main">Add Booking by Drag</button>
              <span class="muted text-sm">Rooms 1–7 × 05:00–24:00 (30-min slots)</span>
            </div>
          </div>
          <div id="calendar" class="grid-scroll"></div>
        </div>
        <div class="card p-4">
          <div class="text-lg font-semibold">Today Summary</div>
          <div class="h-px bg-slate-700 my-3"></div>
          <div class="space-y-2 text-sm">
            <div>Bookings: <span id="sumRes">0</span> <span class="badge" id="sumDate"></span></div>
            <div>Booking Fees: <span id="sumFees">₱0</span></div>
          </div>
          <div class="h-px bg-slate-700 my-3"></div>
          <div class="text-sm muted">Click a block to edit/delete.</div>
        </div>
      </div>
    </section>

    <!-- Sales -->
    <section id="tab-sales" class="hidden">
      <div class="space-y-4">
        <div class="text-xl font-semibold">Sales (POS)</div>
        <div class="card p-4">
          <div class="grid md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <div class="muted text-sm mb-1">Inventory Item</div>
              <select id="selProd" class="input"></select>
            </div>
            <div>
              <div class="muted text-sm mb-1">Qty</div>
              <input id="selQty" type="number" class="input" min="1" value="1"/>
            </div>
            <div class="md:col-span-3">
              <button class="btn btn-main" id="sellBtn">Record Sale</button>
            </div>
          </div>
        </div>
        <div class="card p-4">
          <div class="grid md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <div class="muted text-sm mb-1">Custom Item</div>
              <input id="cName" class="input" placeholder="e.g., Time Fee, Drinks"/>
            </div>
            <div>
              <div class="muted text-sm mb-1">Unit Price (₱)</div>
              <input id="cPrice" type="number" class="input" min="0" value="0"/>
            </div>
            <div>
              <div class="muted text sm mb-1">Qty</div>
              <input id="cQty" type="number" class="input" min="1" value="1"/>
            </div>
            <div class="md:col-span-3">
              <button class="btn btn-main" id="recCustomBtn">Record Custom Sale</button>
            </div>
          </div>
        </div>
        <div class="card p-4">
          <div class="text-lg font-semibold mb-2">Today's Sales</div>
          <div class="overflow-auto">
            <table class="table w-full text-sm" id="salesTable">
              <thead><tr><th>Time</th><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Inventory -->
    <section id="tab-inventory" class="hidden">
      <div class="space-y-4">
        <div class="text-xl font-semibold">Inventory</div>
        <div class="card p-4">
          <div class="grid md:grid-cols-6 gap-3">
            <input id="iSku" class="input" placeholder="SKU"/>
            <input id="iName" class="input md:col-span-2" placeholder="Name"/>
            <input id="iCat" class="input" placeholder="Category"/>
            <input id="iPrice" type="number" class="input" min="0" value="0"/>
            <input id="iStock" type="number" class="input" min="0" value="0"/>
            <input id="iReo" type="number" class="input" min="0" value="0"/>
            <button class="btn btn-main md:col-span-6" id="addProdBtn">Add Product</button>
          </div>
        </div>
        <div class="card p-4">
          <div class="text-lg font-semibold mb-2">Products</div>
          <div class="overflow-auto">
            <table class="table w-full text-sm" id="invTable">
              <thead><tr><th>SKU</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Reorder</th><th>Adjust</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Members -->
    <section id="tab-members" class="hidden">
      <div class="space-y-4">
        <div class="text-xl font-semibold">Members</div>
        <div class="card p-4">
          <div class="grid md:grid-cols-6 gap-3">
            <input id="mName" class="input" placeholder="Name"/>
            <input id="mPhone" class="input" placeholder="Phone"/>
            <input id="mShip" class="input" placeholder="Membership (e.g., Regular, VIP)"/>
            <input id="mLocker" class="input" placeholder="Locker # (optional)"/>
            <input id="mTier" class="input" placeholder="Tier (e.g., Bronze/Silver/Gold)"/>
            <input id="mMemo" class="input" placeholder="Memo"/>
            <button class="btn btn-main md:col-span-6" id="addMemBtn">Add Member</button>
          </div>
        </div>
        <div class="card p-4">
          <div class="flex items-center gap-2 mb-3">
            <div class="text-lg font-semibold">Member List</div>
            <input id="memSearch" class="input ml-auto w-[260px]" placeholder="Search by name or phone"/>
          </div>
          <div class="overflow-auto">
            <table class="table w-full text-sm" id="memTable">
              <thead><tr><th>Name</th><th>Phone</th><th>Membership</th><th>Locker</th><th>Tier</th><th>Memo</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Lockers -->
    <section id="tab-lockers" class="hidden">
      <div class="space-y-4">
        <div class="flex items-center gap-2">
          <div class="text-xl font-semibold">Lockers</div>
          <span class="pill">60 boxes</span>
          <span class="muted text-sm">Click a box → assign member + start/end date. Grid shows name + D-day (D30, D29...).</span>
        </div>
        <div id="lockerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-3"></div>
      </div>
    </section>

    <!-- Reports -->
    <section id="tab-reports" class="hidden">
      <div class="space-y-4">
        <div class="text-xl font-semibold">Daily Report</div>
        <div class="card p-4">
          <div class="flex items-center gap-2">
            <input type="date" id="repDate" class="input w-[200px]"/>
            <button class="btn" id="repLoad">Load</button>
            <div class="ml-auto text-xl">Total: <span id="repTotal">₱0</span></div>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="text-lg font-semibold mb-2">Sales (POS)</div>
            <table class="table w-full text-sm" id="repSalesT">
              <thead><tr><th>Time</th><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card p-4">
            <div class="text-lg font-semibold mb-2">Booking Fees</div>
            <table class="table w-full text-sm" id="repFeesT">
              <thead><tr><th>Time</th><th>Room</th><th>Name</th><th>Fee</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Booking Modal -->
  <div id="overlay" class="overlay hidden">
    <div class="modal card p-4">
      <div class="text-lg font-semibold mb-2" id="modalTitle">Add Booking</div>
      <div class="grid md:grid-cols-2 gap-3">
        <div><div class="text-sm mb-1 muted">Name</div><input id="m_name" class="input"/></div>
        <div><div class="text-sm mb-1 muted">Phone</div><input id="m_phone" class="input"/></div>
        <div><div class="text-sm mb-1 muted">People</div><input id="m_people" type="number" min="1" max="6" class="input" value="4"/></div>
        <div><div class="text-sm mb-1 muted">Fee (₱)</div><input id="m_fee" type="number" min="0" class="input" value="0"/></div>
        <div class="md:col-span-2"><div class="text-sm mb-1 muted">Notes</div><input id="m_notes" class="input"/></div>
      </div>
      <div class="muted text-sm mt-2" id="m_range"></div>
      <div class="flex gap-2 mt-3">
        <button id="saveBtn" class="btn btn-main">Save</button>
        <button id="deleteBtn" class="btn btn-danger hidden">Delete</button>
        <button id="cancelBtn" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Locker Assign Modal -->
  <div id="lockerOverlay" class="overlay hidden">
    <div class="modal card p-4">
      <div class="text-lg font-semibold mb-2">Assign Locker <span id="lockerTitle"></span></div>
      <div class="grid md:grid-cols-2 gap-3">
        <div class="md:col-span-2">
          <div class="text-sm mb-1 muted">Search member (name or phone)</div>
          <input id="lkSearch" class="input" placeholder="Start typing…"/>
          <div id="lkResults" class="mt-2 max-h-40 overflow-auto"></div>
        </div>
        <div>
          <div class="text-sm mb-1 muted">Start date</div>
          <input id="lkStart" type="date" class="input"/>
        </div>
        <div>
          <div class="text-sm mb-1 muted">End date</div>
          <input id="lkEnd" type="date" class="input"/>
        </div>
        <div class="md:col-span-2">
          <div class="text-sm mb-1 muted">Quick set</div>
          <div class="flex gap-2 flex-wrap">
            <button class="btn" data-add="30">+30 days</button>
            <button class="btn" data-add="60">+60 days</button>
            <button class="btn" data-add="90">+90 days</button>
          </div>
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button id="lkSave" class="btn btn-main">Save</button>
        <button id="lkClear" class="btn btn-danger">Clear</button>
        <button id="lkClose" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   State / Cloud (Firestore)
   ========================= */
const ROOMS = ["ROOM 1","ROOM 2","ROOM 3","ROOM 4","ROOM 5","ROOM 6","ROOM 7"];
const LOCKER_COUNT = 60;
const KEY = {
  reservations:"sg_v462_res",
  inventory:"sg_v462_inv",
  sales:"sg_v462_sales",
  members:"sg_v462_members",
  pricing:"sg_v462_pr",
  cloud:"sg_v462_cloud",
  sessions:"sg_v462_sessions",
  lockers:"sg_v462_lockers"
};
const currency = n => new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(n||0);
function todayKey(){ return new Date().toISOString().slice(0,10); }
function p2(n){ return String(n).padStart(2,'0'); }
function buildSlots(){ const a=[]; for(let h=5;h<=23;h++){ a.push(p2(h)+":00"); a.push(p2(h)+":30"); } a.push("24:00"); return a; }
const SLOTS = buildSlots();
function uid(){ return crypto.randomUUID?.() || Math.random().toString(36).slice(2,10); }
function load(k, init){ try{ return JSON.parse(localStorage.getItem(k)||"null") ?? init }catch{ return init } }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

// ✅ 중복 초기화 방지 버전
const Cloud = {
  app:null, db:null, cfg:null, unsub:[],
  ready(){ return !!this.db; },

  setConfig(json){
    try{
      this.cfg = typeof json === 'string' ? JSON.parse(json) : json;
      localStorage.setItem(KEY.cloud, JSON.stringify(this.cfg));
      // 이미 초기화된 앱이 있으면 재사용
      if (!firebase.apps.length) {
        this.app = firebase.initializeApp(this.cfg);
      } else {
        this.app = firebase.app();
      }
      this.db = firebase.firestore();
    }catch(e){
      console.error(e);
      alert("Cloud config error: " + e.message);
    }
  },

  clear(){
    this.unsub.forEach(u=>{try{u()}catch{}});
    this.unsub=[]; this.app=null; this.db=null; this.cfg=null;
    localStorage.removeItem(KEY.cloud);
  },

  watchReservations(date, cb){
    if(!this.db) return ()=>{};
    const u=this.db.collection('reservations').doc(date).collection('records')
      .onSnapshot(s=>{ const a=[]; s.forEach(d=>a.push(d.data())); cb(a); });
    this.unsub.push(u); return u;
  },
  async addReservation(r){ await this.db.collection('reservations').doc(r.date).collection('records').doc(r.id).set(r); },
  async updateReservation(r){ await this.db.collection('reservations').doc(r.date).collection('records').doc(r.id).update(r); },
  async deleteReservation(r){ await this.db.collection('reservations').doc(r.date).collection('records').doc(r.id).delete(); },

  watchSales(date, cb){
    if(!this.db) return ()=>{};
    const u=this.db.collection('sales').doc(date).collection('records').orderBy('ts','desc')
      .onSnapshot(s=>{ const a=[]; s.forEach(d=>a.push(d.data())); cb(a); });
    this.unsub.push(u); return u;
  },
  async addSale(row){ await this.db.collection('sales').doc(row.ts.slice(0,10)).collection('records').doc(row.id).set(row); },

  async setCollection(name, list){
    const batch=this.db.batch(); const col=this.db.collection(name);
    const snap=await col.get(); snap.forEach(doc=>batch.delete(doc.ref));
    list.forEach(item=> batch.set(col.doc(item.id||uid()), item));
    await batch.commit();
  },

  watchSessions(date, cb){
    if(!this.db) return ()=>{};
    const u=this.db.collection('sessions').doc(date).collection('rooms')
      .onSnapshot(s=>{ const map={}; s.forEach(doc=> map[doc.id]=doc.data()); cb(map); });
    this.unsub.push(u); return u;
  },
  async setSession(date, room, data){ await this.db.collection('sessions').doc(date).collection('rooms').doc(room).set(data, {merge:true}); },
  async clearSession(date, room){ await this.db.collection('sessions').doc(date).collection('rooms').doc(room).delete(); },

  watchLockers(cb){
    if(!this.db) return ()=>{};
    const u=this.db.collection('lockers').onSnapshot(s=>{ const map={}; s.forEach(doc=> map[doc.id]=doc.data()); cb(map); });
    this.unsub.push(u); return u;
  },
  async setLocker(num, data){ await this.db.collection('lockers').doc(String(num)).set(data, {merge:true}); },
  async clearLocker(num){ await this.db.collection('lockers').doc(String(num)).delete(); }
};

const state = {
  date: todayKey(),
  reservations: load(KEY.reservations, []),
  inventory: load(KEY.inventory, [
    {id:uid(), sku:"BALL-TP5", name:"TaylorMade TP5 (12)", category:"Goods", price:690, stock:24, reorder:6},
    {id:uid(), sku:"TEE-70MM", name:"Wood Tee 70mm (100)", category:"Consumables", price:120, stock:120, reorder:20},
    {id:uid(), sku:"DRINK-ION", name:"Ion Drink 500ml", category:"F&B", price:50, stock:60, reorder:10}
  ]),
  sales: load(KEY.sales, []),
  members: load(KEY.members, []),
  pricing: load(KEY.pricing, { weekday:1200, weekend:1500, mulMorning:1.0, mulAfternoon:1.2, mulEvening:1.5 }),
  sessions: load(KEY.sessions, {}),
  lockers: load(KEY.lockers, {}),
  resUnsub:null, salesUnsub:null, sessUnsub:null, lkUnsub:null,
  modeAdd:false, drag:null, editing:null
};

/* =========================
   Pricing helpers
   ========================= */
function isWeekend(dateStr){ const d=new Date(dateStr); const w=d.getDay(); return w===0 || w===6; }
function multiplier(hour){ if(hour<11) return state.pricing.mulMorning||1; if(hour<17) return state.pricing.mulAfternoon||1.2; return state.pricing.mulEvening||1.5; }
function calcFee(dateStr, sIdx, eIdx){
  const base = isWeekend(dateStr)? (state.pricing.weekend||0) : (state.pricing.weekday||0);
  let t=0; for(let i=sIdx;i<eIdx;i++){ const h=parseInt(SLOTS[i].slice(0,2),10); t += base*multiplier(h)*0.5; } return Math.round(t);
}

/* =========================
   Reservations
   ========================= */
function overlaps(a,b){ return a.date===b.date && a.room===b.room && Math.max(a.start,b.start) < Math.min(a.end,b.end); }
function buildCalendar(){
  const el=document.getElementById('calendar'); el.innerHTML="";
  const table=document.createElement('div'); table.className="grid"; table.style.gridTemplateColumns = `140px repeat(${ROOMS.length}, 1fr)`;
  const corner=document.createElement('div'); corner.className="roomheader"; corner.innerText="Time"; table.appendChild(corner);
  ROOMS.forEach(r=>{ const h=document.createElement('div'); h.className="roomheader"; h.innerText=r; table.appendChild(h); });
  for(let ri=0; ri<SLOTS.length; ri++){
    const tl=document.createElement('div'); tl.className="timecell"; tl.innerText=SLOTS[ri]; table.appendChild(tl);
    for(let ci=0; ci<ROOMS.length; ci++){
      const cell=document.createElement('div'); cell.className="cell"; cell.dataset.room=ROOMS[ci]; cell.dataset.idx=ri;
      cell.addEventListener('mousedown', ()=>{ if(!state.modeAdd) return; state.drag={room:cell.dataset.room,startIdx:ri,endIdx:ri}; cell.classList.add('selecting'); });
      cell.addEventListener('mouseenter', ()=>{ if(!state.drag) return; if(state.drag.room!==cell.dataset.room) return;
        state.drag.endIdx=ri; document.querySelectorAll('.cell.selecting').forEach(x=>x.classList.remove('selecting'));
        const mi=Math.min(state.drag.startIdx, state.drag.endIdx), ma=Math.max(state.drag.startIdx, state.drag.endIdx);
        for(let i=mi;i<=ma;i++){ const sel=document.querySelector(`.cell[data-room="${state.drag.room}"][data-idx="${i}"]`); if(sel) sel.classList.add('selecting'); }
      });
      cell.addEventListener('mouseup', ()=>{
        if(!state.drag) return;
        const mi=Math.min(state.drag.startIdx, state.drag.endIdx), ma=Math.max(state.drag.startIdx, state.drag.endIdx);
        openCreateModal(state.drag.room, mi, Math.min(ma+1, SLOTS.length-1));
        document.querySelectorAll('.cell.selecting').forEach(x=>x.classList.remove('selecting'));
        state.drag=null; state.modeAdd=false; document.getElementById('addGameBtn').innerText="Add Booking by Drag";
      });
      table.appendChild(cell);
    }
  }
  el.appendChild(table);

  const todays = state.reservations.filter(r=> r.date===state.date);
  todays.forEach(r=>{
    const first=document.querySelector(`.cell[data-room="${r.room}"][data-idx="${r.start}"]`);
    if(first){
      const div=document.createElement('div'); div.className="booking"; div.style.top="2px"; div.style.height=`calc(${(r.end-r.start)*36}px - 4px)`;
      div.innerHTML = `<div class="font-semibold truncate">${r.name||"(No name)"}${r.phone? " · "+r.phone:""}</div><div class="text-xs opacity-80">${SLOTS[r.start]}–${SLOTS[r.end]} · ${r.people||1}p · ${currency(r.fee||0)}</div>`;
      div.addEventListener('click', (e)=>{ e.stopPropagation(); openEditModal(r); });
      first.appendChild(div);
    }
    for(let i=r.start;i<r.end;i++){ const c=document.querySelector(`.cell[data-room="${r.room}"][data-idx="${i}"]`); if(c) c.style.background="rgba(59,130,246,0.12)"; }
  });
  sumToday();
}
function sumToday(){
  const items=state.reservations.filter(r=> r.date===state.date);
  document.getElementById('sumRes').textContent=items.length;
  document.getElementById('sumFees').textContent=currency(items.reduce((s,r)=>s+(r.fee||0),0));
  document.getElementById('sumDate').textContent=state.date;
}

function openCreateModal(room, sIdx, eIdx){
  const fee=calcFee(state.date, sIdx, eIdx);
  document.getElementById('overlay').classList.remove('hidden');
  document.getElementById('modalTitle').textContent="Add Booking";
  m_name.value=""; m_phone.value=""; m_people.value=4; m_fee.value=fee; m_notes.value="";
  deleteBtn.classList.add('hidden');
  document.getElementById('m_range').textContent=`${room} · ${SLOTS[sIdx]} – ${SLOTS[eIdx]} (auto fee: ${currency(fee)})`;
  state.editing = { id:uid(), date:state.date, room, start:sIdx, end:eIdx, name:"", phone:"", people:4, fee, notes:"" };
  saveBtn.onclick = async ()=>{
    const clash=state.reservations.some(r=> overlaps(r, state.editing));
    if(clash){ alert("Overlapping booking exists."); return; }
    Object.assign(state.editing, { name:m_name.value.trim(), phone:m_phone.value.trim(), people:parseInt(m_people.value||"1"), fee:parseInt(m_fee.value||"0"), notes:m_notes.value.trim() });
    if(Cloud.ready()){ await Cloud.addReservation(state.editing); } else { state.reservations.push(state.editing); save(KEY.reservations, state.reservations); }
    closeModal(); buildCalendar();
  };
  cancelBtn.onclick = ()=> closeModal();
}
function openEditModal(rec){
  document.getElementById('overlay').classList.remove('hidden');
  document.getElementById('modalTitle').textContent="Edit Booking";
  m_name.value=rec.name||""; m_phone.value=rec.phone||""; m_people.value=rec.people||1; m_fee.value=rec.fee||0; m_notes.value=rec.notes||"";
  document.getElementById('m_range').textContent = `${rec.room} · ${SLOTS[rec.start]} – ${SLOTS[rec.end]}`;
  deleteBtn.classList.remove('hidden');
  state.editing = rec;
  saveBtn.onclick = async ()=>{
    Object.assign(rec, { name:m_name.value.trim(), phone:m_phone.value.trim(), people:parseInt(m_people.value||"1"), fee:parseInt(m_fee.value||"0"), notes:m_notes.value.trim() });
    if(Cloud.ready()){ await Cloud.updateReservation(rec); } else { save(KEY.reservations, state.reservations); }
    closeModal(); buildCalendar();
  };
  deleteBtn.onclick = async ()=>{
    if(confirm("Delete this booking?")){
      if(Cloud.ready()){ await Cloud.deleteReservation(rec); }
      state.reservations = state.reservations.filter(r=> r.id!==rec.id); save(KEY.reservations, state.reservations);
      closeModal(); buildCalendar();
    }
  };
  cancelBtn.onclick = ()=> closeModal();
}
function closeModal(){ document.getElementById('overlay').classList.add('hidden'); state.editing=null; }

/* =========================
   Dashboard (sessions)
   ========================= */
function perMinuteRate(dateObj){
  const base=isWeekend(state.date)? (state.pricing.weekend||0) : (state.pricing.weekday||0);
  const h=dateObj.getHours();
  const mul=(h<11?state.pricing.mulMorning: h<17?state.pricing.mulAfternoon:state.pricing.mulEvening)||1;
  return (base*mul)/60;
}
function accruedTimeFee(startISO, endISO, manualFee){
  if(manualFee && manualFee>0) return manualFee;
  const start=new Date(startISO), end=new Date(endISO);
  let sum=0; const cur=new Date(start);
  while(cur<end){ sum += perMinuteRate(cur); cur.setMinutes(cur.getMinutes()+1); }
  return Math.round(sum);
}
function dashDataFor(room){
  const sess=(state.sessions[state.date]||{})[room];
  if(!sess) return {running:false, amount:0, remain:0, items:[]};
  const now=new Date(); const end=new Date(sess.end);
  const remainMs=Math.max(0,end-now);
  const timeFee=accruedTimeFee(sess.start, new Date(Math.min(now,end)).toISOString(), sess.manualFee||0);
  const itemsTotal=(sess.items||[]).reduce((s,it)=> s+(it.total||0), 0);
  return { running: now<end, amount: timeFee+itemsTotal, remain: remainMs, items:sess.items||[] };
}
function renderDashboard(){
  const grid=document.getElementById('dashGrid'); grid.innerHTML="";
  ROOMS.forEach(room=>{
    const d=dashDataFor(room);
    const card=document.createElement('div'); card.className="dash-card";
    card.innerHTML=`<div class="flex items-center justify-between">
        <div class="text-lg font-semibold">${room}</div>
        <span class="status ${d.running?'run':'idle'}">${d.running?'Running':'Idle'}</span>
      </div>
      <div class="mt-2 big">${currency(d.amount)}</div>
      <div class="sub">${d.running?('Remaining: '+fmtRemain(d.remain)):'Remaining: -'}</div>`;
    card.onclick=()=> openRoom(room);
    grid.appendChild(card);
  });
}
function fmtRemain(ms){
  const s=Math.floor(ms/1000);
  const hh=String(Math.floor(s/3600)).padStart(2,'0');
  const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss=String(s%60).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}
function openRoom(room){
  window._room = room;
  const overlay = document.createElement('div');
  overlay.className='overlay'; overlay.style.display='flex';
  overlay.innerHTML = `<div class="modal card p-4">
    <div class="text-lg font-semibold mb-2">${room} — Live Session</div>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 card p-3">
        <div class="font-semibold mb-2">Timer</div>
        <div class="grid grid-cols-2 gap-2">
          <label>Minutes (from now) <input id="sessMinutes" type="number" class="input" value="60" min="10" step="5"></label>
          <label>Manual fee (optional) <input id="sessManualFee" type="number" class="input" value="" placeholder="If empty, auto fee"></label>
        </div>
        <div class="flex gap-2 mt-2">
          <button class="btn btn-main" id="sessStart">Start / Restart</button>
          <button class="btn" id="sessExtend">+30 min</button>
          <button class="btn btn-danger" id="sessStop">Settle</button>
        </div>
        <div class="mt-3 text-sm muted">Remaining: <span id="sessRemain">00:00:00</span> · Current fee: <span id="sessAmount">₱0</span></div>
      </div>
      <div class="card p-3">
        <div class="font-semibold mb-2">Add Item to Room</div>
        <div class="grid grid-cols-1 gap-2">
          <div class="grid grid-cols-2 gap-2">
            <select id="sessCat" class="input"><option value="">All categories</option></select>
            <input id="sessSearch" class="input" placeholder="Search by name"/>
          </div>
          <select id="sessProd" class="input"></select>
          <input id="sessQty" type="number" class="input" value="1" min="1">
          <button class="btn btn-main" id="sessAddItem">Add</button>
        </div>
      </div>
      <div class="md:col-span-3 card p-3">
        <div class="font-semibold mb-2">Applied Items</div>
        <div class="overflow-auto" style="max-height:200px;">
          <table class="table w-full text-sm" id="sessTable">
            <thead>
              <tr><th>Item</th><th>Qty</th><th>Total</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="flex gap-2 mt-3"><button class="btn" id="roomClose">Close</button></div>
  </div>`;
  document.body.appendChild(overlay);
  function close(){ clearInterval(overlay._tick); document.body.removeChild(overlay); }
  overlay.addEventListener('click', e=>{ if(e.target===overlay) close(); });

  // fill category & product selects with filtering
  const catSel=overlay.querySelector('#sessCat');
  const prodSel=overlay.querySelector('#sessProd');
  const searchInp=overlay.querySelector('#sessSearch');
  const categories=[...new Set(state.inventory.map(p=>p.category||""))].filter(Boolean).sort();
  categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
  function fillProducts(){
    const q=(searchInp.value||"").toLowerCase().trim();
    const cat=catSel.value||"";
    prodSel.innerHTML="";
    const def=document.createElement('option'); def.value=""; def.textContent="- Select -"; prodSel.appendChild(def);
    state.inventory.filter(p=> (cat==="" || (p.category||"")===cat) && (!q || (p.name||"").toLowerCase().includes(q))).forEach(p=>{
      const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} — ${currency(p.price)} (stock ${p.stock})`; prodSel.appendChild(o);
    });
  }
  catSel.onchange = fillProducts;
  searchInp.oninput = fillProducts;
  fillProducts();

  overlay.querySelector('#roomClose').onclick=close;
  overlay.querySelector('#sessStart').onclick=()=> sessStart(room, overlay);
  overlay.querySelector('#sessExtend').onclick=()=> sessExtend(room, 30, overlay);
  overlay.querySelector('#sessStop').onclick=()=> sessStop(room, overlay);
  overlay.querySelector('#sessAddItem').onclick=()=> sessAddItem(room, overlay);
  updateSessUI(room, overlay);
  overlay._tick = setInterval(()=> updateSessUI(room, overlay), 1000);
}
function sessObj(room){ const byDate=state.sessions[state.date]||(state.sessions[state.date]={}); return byDate[room]; }
function updateSessUI(room, overlay){
  const sess = sessObj(room);
  const remainEl = overlay.querySelector('#sessRemain');
  const amountEl = overlay.querySelector('#sessAmount');
  const tbody = overlay.querySelector('#sessTable tbody');
  tbody.innerHTML = "";

  if(!sess){
    remainEl.textContent="00:00:00";
    amountEl.textContent="₱0";
    return;
  }

  const now = new Date();
  const end = new Date(sess.end);
  const remain = Math.max(0, end - now);
  const amount = dashDataFor(room).amount;

  remainEl.textContent = fmtRemain(remain);
  amountEl.textContent  = currency(amount);

  (sess.items || []).forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td>${it.qty}</td>
      <td>${currency(it.total)}</td>
      <td class="text-right">
        <button class="btn btn-danger" data-remove="${idx}" title="Remove 1">−</button>
      </td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-remove]').forEach(btn=>{
    btn.onclick = () => {
      const idx = parseInt(btn.getAttribute('data-remove'),10);
      sessRemoveOne(room, idx, overlay);
    };
  });
}
function sessRemoveOne(room, itemIndex, overlay){
  const sess = sessObj(room);
  if(!sess || !sess.items || itemIndex<0 || itemIndex>=sess.items.length) return;

  const it = sess.items[itemIndex];
  const prod = state.inventory.find(p => p.id === it.productId);
  if(prod){ prod.stock = (prod.stock||0) + 1; }

  it.qty = (it.qty || 0) - 1;
  it.total = Math.max(0, (it.total||0) - (it.price||0));
  if(it.qty <= 0){ sess.items.splice(itemIndex, 1); }

  const refundRow = {
    id: uid(), ts: new Date().toISOString(),
    itemType: "refund", itemName: it.name + " (refund)",
    productId: it.productId || null, qty: 1,
    price: -(it.price||0), total: -(it.price||0)
  };
  state.sales.unshift(refundRow);

  save(KEY.inventory, state.inventory);
  save(KEY.sessions, state.sessions);
  save(KEY.sales, state.sales);
  if(Cloud.ready()){
    Cloud.setCollection('inventory', state.inventory);
    Cloud.setSession(state.date, room, sess);
    Cloud.addSale(refundRow);
  }

  if(document.querySelector('#tab-sales:not(.hidden)')) refreshSalesToday();
  updateSessUI(room, overlay);
  renderDashboard();
}
function sessStart(room, overlay){
  const mins=parseInt(overlay.querySelector('#sessMinutes').value||"60");
  const manualFee=parseInt(overlay.querySelector('#sessManualFee').value||"");
  const now=new Date(); const end=new Date(now.getTime()+mins*60000);
  const entry={ start:now.toISOString(), end:end.toISOString(), manualFee:(isNaN(manualFee)?0:manualFee), items:[] };
  if(!state.sessions[state.date]) state.sessions[state.date]={}; state.sessions[state.date][room]=entry; save(KEY.sessions,state.sessions);
  if(Cloud.ready()) Cloud.setSession(state.date, room, entry);
  updateSessUI(room, overlay); renderDashboard();
}
function sessExtend(room, plusMin, overlay){
  const sess=sessObj(room); if(!sess){ alert("Start the timer first."); return; }
  const end=new Date(sess.end); end.setMinutes(end.getMinutes()+plusMin); sess.end=end.toISOString(); save(KEY.sessions,state.sessions);
  if(Cloud.ready()) Cloud.setSession(state.date, room, sess);
  updateSessUI(room, overlay); renderDashboard();
}
function sessAddItem(room, overlay){
  const pid=overlay.querySelector('#sessProd').value; const qty=parseInt(overlay.querySelector('#sessQty').value||"1");
  if(!pid||qty<=0) return;
  const p=state.inventory.find(x=>x.id===pid); if(!p){ alert("Product not found."); return; }
  if((p.stock||0)<qty){ alert("Not enough stock."); return; }
  p.stock -= qty;
  const it={ productId:p.id, name:p.name, qty, price:p.price, total:(p.price||0)*qty };
  const sess=state.sessions[state.date][room]||(state.sessions[state.date][room]={start:new Date().toISOString(), end:new Date().toISOString(), manualFee:0, items:[]});
  sess.items=sess.items||[]; sess.items.push(it);
  const saleRow={ id:uid(), ts:new Date().toISOString(), itemType:"inventory", itemName:p.name, productId:p.id, qty, price:p.price, total:(p.price||0)*qty };
  state.sales.unshift(saleRow);
  save(KEY.inventory,state.inventory); save(KEY.sessions,state.sessions); save(KEY.sales,state.sales);
  if(Cloud.ready()){ Cloud.setCollection('inventory', state.inventory); Cloud.setSession(state.date, room, sess); Cloud.addSale(saleRow); }
  if(document.querySelector('#tab-sales:not(.hidden)')) refreshSalesToday();
  updateSessUI(room, overlay); renderDashboard();
}
function sessStop(room, overlay){
  const sess=sessObj(room); if(!sess){ return; }
  const now=new Date(); const end=new Date(sess.end); const stopTime=new Date(Math.min(now,end));
  const timeAmount=accruedTimeFee(sess.start, stopTime.toISOString(), sess.manualFee||0);
  const itemsTotal=(sess.items||[]).reduce((s,it)=> s+(it.total||0), 0);
  const finalTotal=timeAmount+itemsTotal;
  const feeRow={ id:uid(), ts:new Date().toISOString(), itemType:"custom", itemName:`Time Fee ${room}`, productId:null, qty:1, price:finalTotal, total:finalTotal };
  state.sales.unshift(feeRow); save(KEY.sales,state.sales); if(Cloud.ready()) Cloud.addSale(feeRow);
  delete state.sessions[state.date][room]; save(KEY.sessions,state.sessions); if(Cloud.ready()) Cloud.clearSession(state.date, room);
  renderDashboard(); alert(`${room} settled: ${currency(finalTotal)}`); overlay.querySelector('#roomClose').click();
}

/* =========================
   Sales / Inventory / Members / Reports
   ========================= */
function refreshSalesToday(){
  const tb=document.querySelector('#salesTable tbody'); if(!tb) return; tb.innerHTML="";
  const rows=state.sales.filter(s=> s.ts.startsWith(state.date));
  rows.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(s.ts).toLocaleTimeString()}</td><td>${s.itemName}</td><td>${s.qty}</td><td>${currency(s.total)}</td>`;
    tb.appendChild(tr);
  });
}
function refreshSalesProductSelect(){
  const sel=document.getElementById('selProd'); if(!sel) return; sel.innerHTML="";
  const def=document.createElement('option'); def.value=""; def.textContent="- Select -"; sel.appendChild(def);
  state.inventory.forEach(p=>{
    const o=document.createElement('option');
    o.value=p.id; o.textContent=`${p.name} — ${currency(p.price)} (stock ${p.stock})`;
    sel.appendChild(o);
  });
}
function refreshInventory(){
  const tb=document.querySelector('#invTable tbody'); if(!tb) return; tb.innerHTML="";
  state.inventory.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.sku||""}</td><td>${p.name}</td><td>${p.category||""}</td><td>${currency(p.price||0)}</td><td>${p.stock||0}</td><td>${p.reorder||0}</td><td><div class="flex gap-1"><button class="btn" data-a="+">+1</button><button class="btn" data-a="-">-1</button></div></td>`;
    tr.querySelector('button[data-a="+"]').onclick=async()=>{
      p.stock=(p.stock||0)+1; save(KEY.inventory,state.inventory);
      if(Cloud.ready()) await Cloud.setCollection("inventory", state.inventory);
      refreshInventory(); refreshSalesProductSelect();
    };
    tr.querySelector('button[data-a="-"]').onclick=async()=>{
      p.stock=Math.max(0,(p.stock||0)-1); save(KEY.inventory,state.inventory);
      if(Cloud.ready()) await Cloud.setCollection("inventory", state.inventory);
      refreshInventory(); refreshSalesProductSelect();
    };
    tb.appendChild(tr);
  });
}
function refreshMembers(filter=""){
  const tb=document.querySelector('#memTable tbody'); if(!tb) return;
  const f=filter.trim().toLowerCase(); tb.innerHTML="";
  state.members.filter(m=>{
    if(!f) return true;
    return (m.name||"").toLowerCase().includes(f) || (m.phone||"").toLowerCase().includes(f);
  }).forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m.name}</td><td>${m.phone||""}</td><td>${m.membership||""}</td><td>${m.locker||""}</td><td>${m.tier||""}</td><td>${m.memo||""}</td>`;
    tb.appendChild(tr);
  });
}
function loadReport(key){
  const pos=state.sales.filter(s=> s.ts.startsWith(key));
  const fee=state.reservations.filter(r=> r.date===key);
  const posTotal=pos.reduce((sum,s)=> sum+(s.total||0),0);
  const feeTotal=fee.reduce((sum,r)=> sum+(r.fee||0),0);
  document.getElementById('repTotal').textContent=currency(posTotal+feeTotal);
  const tb1=document.querySelector('#repSalesT tbody'); tb1.innerHTML="";
  pos.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(s.ts).toLocaleTimeString()}</td><td>${s.itemName}</td><td>${s.qty}</td><td>${currency(s.total)}</td>`;
    tb1.appendChild(tr);
  });
  const tb2=document.querySelector('#repFeesT tbody'); tb2.innerHTML="";
  fee.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${SLOTS[r.start]}</td><td>${r.room}</td><td>${r.name}</td><td>${currency(r.fee)}</td>`;
    tb2.appendChild(tr);
  });
}

// Members add/search
function addMember(m){
  m.id = m.id || uid();
  state.members.unshift(m); save(KEY.members, state.members);
  if(Cloud.ready()) Cloud.setCollection('members', state.members);
  refreshMembers(memSearch?.value||"");
}
function setupMembersUI(){
  document.getElementById('addMemBtn').onclick = ()=>{
    const m = { name:mName.value.trim(), phone:mPhone.value.trim(), membership:mShip.value.trim(), locker:mLocker.value.trim(), tier:mTier.value.trim(), memo:mMemo.value.trim(), id:uid() };
    if(!m.name){ alert("Name is required."); return; }
    addMember(m);
    mName.value=""; mPhone.value=""; mShip.value=""; mLocker.value=""; mTier.value=""; mMemo.value="";
  };
  document.getElementById('memSearch').addEventListener('input', (e)=> refreshMembers(e.target.value));
  refreshMembers();
}

/* =========================
   Lockers (D-day)
   ========================= */
function daysBetween(baseISO, endISO){
  const t = new Date(baseISO); t.setHours(0,0,0,0);
  const e = new Date(endISO); e.setHours(0,0,0,0);
  return Math.ceil((e - t)/86400000);
}
function baseDateISO(){ return state.date || todayKey(); }
function renderLockers(){
  const g=document.getElementById('lockerGrid'); if(!g) return; g.innerHTML="";
  const base=baseDateISO();
  for(let i=1;i<=LOCKER_COUNT;i++){
    const key=String(i); const L=state.lockers[key];
    const card=document.createElement('div'); card.className="locker";
    let labelName = L?.name || '<span class="muted">Unassigned</span>';
    let ddayText = "";
    if(L?.endISO){
      const remain = daysBetween(base, L.endISO);
      if(remain < 0) { ddayText = "Expired"; card.classList.add('danger'); }
      else { ddayText = `D${remain}`; if(remain<=7) card.classList.add('warn'); }
    }
    card.innerHTML = `<div class="num">#${i}</div>
      <div class="name">${labelName}</div>
      <div class="days">${ddayText}${L?.startISO && L?.endISO ? ` · <span class='muted'>${L.startISO} ~ ${L.endISO}</span>`:""}</div>`;
    card.onclick = ()=> openLocker(i);
    g.appendChild(card);
  }
}
function openLocker(num){
  document.getElementById('lockerOverlay').classList.remove('hidden');
  document.getElementById('lockerTitle').textContent = '#'+num;
  const resBox=document.getElementById('lkResults'), search=document.getElementById('lkSearch');
  const lkStart=document.getElementById('lkStart'), lkEnd=document.getElementById('lkEnd');
  const quickBtns = Array.from(document.querySelectorAll('[data-add]'));
  const existing = state.lockers[String(num)];
  if(existing){
    search.value = `${existing.name}${existing.phone? ' · '+existing.phone:''}`;
    search.dataset.memberId = existing.memberId||"";
    lkStart.value = existing.startISO || state.date;
    lkEnd.value = existing.endISO || state.date;
  }else{
    search.value = ""; search.dataset.memberId="";
    lkStart.value = state.date; lkEnd.value = "";
  }
  quickBtns.forEach(b=> b.onclick = ()=>{
    const base = lkStart.value ? new Date(lkStart.value) : new Date(state.date);
    const add = parseInt(b.dataset.add||"0"); base.setDate(base.getDate()+add);
    lkEnd.value = base.toISOString().slice(0,10);
  });
  function refreshSearch(){
    const q=(search.value||"").toLowerCase().trim();
    resBox.innerHTML="";
    state.members.filter(m=> !q || (m.name||"").toLowerCase().includes(q) || (m.phone||"").toLowerCase().includes(q)).slice(0,20).forEach(m=>{
      const btn=document.createElement('button'); btn.className="btn w-full text-left mt-1";
      btn.textContent = `${m.name}${m.phone? ' · '+m.phone:''}${m.membership? ' · '+m.membership:''}`;
      btn.onclick=()=>{ search.value = `${m.name}${m.phone? ' · '+m.phone:''}`; search.dataset.memberId = m.id; };
      resBox.appendChild(btn);
    });
  }
  search.oninput = refreshSearch; refreshSearch();
  document.getElementById('lkClose').onclick = ()=> document.getElementById('lockerOverlay').classList.add('hidden');
  document.getElementById('lkClear').onclick = async ()=>{
    delete state.lockers[String(num)]; save(KEY.lockers, state.lockers);
    if(Cloud.ready()) await Cloud.clearLocker(String(num));
    renderLockers(); document.getElementById('lockerOverlay').classList.add('hidden');
  };
  document.getElementById('lkSave').onclick = async ()=>{
    const selId = search.dataset.memberId || "";
    const sel = state.members.find(m=> m.id===selId) || (search.value? {id:"", name:search.value} : null);
    if(!sel){ alert("Select a member."); return; }
    if(!lkStart.value || !lkEnd.value){ alert("Set start and end dates."); return; }
    const rec = { memberId:sel.id||"", name:sel.name, phone:sel.phone||"", startISO: lkStart.value, endISO: lkEnd.value };
    state.lockers[String(num)] = rec; save(KEY.lockers, state.lockers);
    if(Cloud.ready()) await Cloud.setLocker(String(num), rec);
    renderLockers(); document.getElementById('lockerOverlay').classList.add('hidden');
  };
}

/* =========================
   Tabs / Init
   ========================= */
function setActive(tabId){
  document.querySelectorAll('.tab').forEach(b=> b.classList.toggle('active', b.dataset.tab===tabId));
  document.querySelectorAll('section[id^="tab-"]').forEach(s=> s.classList.add('hidden'));
  document.getElementById('tab-'+tabId).classList.remove('hidden');
  if(tabId==='dashboard') renderDashboard();
  if(tabId==='reservations') buildCalendar();
  if(tabId==='sales'){ refreshSalesToday(); refreshSalesProductSelect(); }
  if(tabId==='inventory') refreshInventory();
  if(tabId==='members') refreshMembers();
  if(tabId==='lockers') renderLockers();
  if(tabId==='reports') loadReport(state.date);
  if(tabId==='pricing'){
    prWeekday.value=state.pricing.weekday;
    prWeekend.value=state.pricing.weekend;
    mulMorning.value=state.pricing.mulMorning;
    mulAfternoon.value=state.pricing.mulAfternoon;
    mulEvening.value=state.pricing.mulEvening;
  }
}
function watchDay(date){
  if(Cloud.ready()){
    if(state.resUnsub){ try{state.resUnsub()}catch{} }
    if(state.salesUnsub){ try{state.salesUnsub()}catch{} }
    if(state.sessUnsub){ try{state.sessUnsub()}catch{} }
    if(state.lkUnsub){ try{state.lkUnsub()}catch{} }

    state.resUnsub = Cloud.watchReservations(date, list=>{
      state.reservations=list; save(KEY.reservations,list);
      if(document.querySelector('#tab-reservations:not(.hidden)')) buildCalendar();
    });
    state.salesUnsub = Cloud.watchSales(date, list=>{
      state.sales = state.sales.filter(s=> !s.ts.startsWith(date)).concat(list);
      save(KEY.sales, state.sales);
      if(document.querySelector('#tab-sales:not(.hidden)')) refreshSalesToday();
    });
    state.sessUnsub = Cloud.watchSessions(date, map=>{
      if(!state.sessions[state.date]) state.sessions[state.date]={};
      state.sessions[state.date]=map; save(KEY.sessions, state.sessions); renderDashboard();
    });
    state.lkUnsub = Cloud.watchLockers(map=>{
      state.lockers = map; save(KEY.lockers, state.lockers);
      if(document.querySelector('#tab-lockers:not(.hidden)')) renderLockers();
    });
  } else {
    buildCalendar(); renderDashboard(); refreshSalesToday(); renderLockers();
  }
}
function init(){
  document.querySelectorAll('.tab').forEach(b=> b.onclick=()=> setActive(b.dataset.tab));
  day.value=state.date;
  day.onchange=()=>{ state.date=day.value; watchDay(state.date); renderLockers(); };
  todayBtn.onclick=()=>{ state.date=todayKey(); day.value=state.date; watchDay(state.date); renderLockers(); };

  addGameBtn.onclick=(e)=>{ state.modeAdd=!state.modeAdd; e.target.textContent = state.modeAdd? "Selecting… (click again to cancel)" : "Add Booking by Drag"; };

  savePricing.onclick=()=>{
    state.pricing={
      weekday:parseInt(prWeekday.value||"0"),
      weekend:parseInt(prWeekend.value||"0"),
      mulMorning:parseFloat(mulMorning.value||"1"),
      mulAfternoon:parseFloat(mulAfternoon.value||"1.2"),
      mulEvening:parseFloat(mulEvening.value||"1.5")
    };
    save(KEY.pricing,state.pricing);
    if(Cloud.ready()) Cloud.setCollection("pricing", [{id:"default", ...state.pricing}]);
    alert("Saved.");
  };

  setupMembersUI();
  setActive('dashboard');
  watchDay(state.date);
  refreshInventory(); refreshSalesProductSelect();

  // Live dashboard ticker every second
  setInterval(renderDashboard, 1000);
}
init();

// live D-day refresh every minute while on Lockers tab
setInterval(()=>{ if(document.querySelector('#tab-lockers:not(.hidden)')) renderLockers(); }, 60000);
</script>
</body>
</html>
